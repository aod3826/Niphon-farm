<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Niphon Farm Smart Center</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: { 
                        primary: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534' },
                        farm: { sow: '#db2777', fatten: '#ea580c', feed: '#ca8a04' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025)',
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.5); }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .pin-btn:active { transform: scale(0.92); background-color: #e2e8f0; transition: transform 0.1s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .shake { animation: shake 0.4s ease-in-out; }
        .no-select { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-800 h-screen overflow-hidden font-sans no-select" x-data="app()" x-init="initApp()">

    <div x-show="loading" class="fixed inset-0 z-[100] bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center transition-opacity" x-transition.opacity>
        <div class="relative mb-4">
            <div class="w-20 h-20 border-4 border-gray-100 border-t-primary-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center text-primary-600 text-2xl"><i class="fa-solid fa-seedling"></i></div>
        </div>
        <p class="text-gray-600 font-bold animate-pulse text-lg" x-text="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</p>
    </div>

    <div class="flex h-full">
        
        <div x-show="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 z-20 bg-slate-900/50 lg:hidden backdrop-blur-sm" x-transition.opacity></div>

        <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'" class="fixed lg:static inset-y-0 left-0 z-30 w-72 bg-white border-r border-gray-100 shadow-2xl lg:shadow-none lg:translate-x-0 transition-transform duration-300 flex flex-col">
            <div class="h-24 flex items-center gap-4 px-6 border-b border-gray-50 bg-gradient-to-br from-primary-50 to-white">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-primary-600 to-primary-400 text-white flex items-center justify-center shadow-lg shadow-primary-200">
                    <i class="fa-solid fa-piggy-bank text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-gray-800 tracking-tight leading-none">Niphon Farm</h1>
                    <p class="text-[11px] text-gray-400 font-semibold tracking-wider mt-1 uppercase">Smart Center v19</p>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-1 hide-scroll">
                
                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-3 pl-3 mt-2">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å</div>
                <template x-for="item in menus.main">
                    <a @click="nav(item.id)" 
                       :class="page===item.id ? 'bg-primary-50 text-primary-700 font-bold shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-700'"
                       class="flex items-center gap-4 px-4 py-3.5 rounded-2xl cursor-pointer transition-all duration-200 group mb-1.5">
                        <i :class="item.icon" class="w-6 text-center text-lg transition-transform group-hover:scale-110" :class="page===item.id?'text-primary-600':''"></i>
                        <span class="text-sm" x-text="item.label"></span>
                    </a>
                </template>

                <div x-show="user" x-transition.origin.top>
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mt-8 mb-3 pl-3">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                    <template x-for="item in menus.hr">
                        <a @click="nav(item.id)" 
                           :class="page===item.id ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-700'"
                           class="flex items-center gap-4 px-4 py-3.5 rounded-2xl cursor-pointer transition-all duration-200 group mb-1.5">
                            <i :class="item.icon" class="w-6 text-center text-lg transition-transform group-hover:scale-110" :class="page===item.id?'text-blue-600':''"></i>
                            <span class="text-sm" x-text="item.label"></span>
                        </a>
                    </template>
                </div>

                <div x-show="user && (user.role === 'admin' || user.role === 'manager')" x-transition.origin.top>
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mt-8 mb-3 pl-3">‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á</div>
                    <template x-for="item in menus.manager">
                        <a @click="nav(item.id)" 
                           :class="page===item.id ? 'bg-purple-50 text-purple-700 font-bold shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-700'"
                           class="flex items-center gap-4 px-4 py-3.5 rounded-2xl cursor-pointer transition-all duration-200 group mb-1.5 justify-between">
                            <div class="flex items-center gap-4">
                                <i :class="item.icon" class="w-6 text-center text-lg transition-transform group-hover:scale-110" :class="page===item.id?'text-purple-600':''"></i>
                                <span class="text-sm" x-text="item.label"></span>
                            </div>
                            <span x-show="item.id==='mgr_approve' && manager.pending.length > 0" 
                                  class="w-6 h-6 flex items-center justify-center bg-red-500 text-white text-[10px] font-bold rounded-full shadow-md animate-pulse" 
                                  x-text="manager.pending.length"></span>
                        </a>
                    </template>
                </div>
            </nav>

            <div class="p-5 border-t border-gray-100 bg-gray-50/50">
                
                <div x-show="!user" class="space-y-3">
                    <div @click="openPinModal()" class="flex items-center gap-4 p-4 rounded-2xl bg-white border border-gray-200 shadow-sm cursor-pointer hover:border-primary-400 hover:shadow-md transition-all group">
                        <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 group-hover:bg-primary-500 group-hover:text-white transition-colors duration-300">
                            <i class="fa-solid fa-fingerprint text-xl"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-gray-700 group-hover:text-primary-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
                            <div class="text-[10px] text-gray-400">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà PIN</div>
                        </div>
                    </div>
                    
                    <button @click="modals.register=true" class="w-full py-2 text-primary-600 text-xs font-bold bg-primary-50 hover:bg-primary-100 rounded-xl transition-colors border border-primary-100">
                        <i class="fa-solid fa-user-plus mr-1"></i> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
                
                <div x-show="user" class="flex items-center gap-3 p-3 rounded-2xl bg-white border border-gray-200 shadow-sm">
                    <div class="relative">
                        <img :src="user?.avatar || 'https://ui-avatars.com/api/?name='+user?.name+'&background=random'" class="w-10 h-10 rounded-full object-cover ring-2 ring-white shadow-sm">
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-gray-800 truncate" x-text="user?.name"></p>
                        <p class="text-[10px] text-gray-500 truncate" x-text="user?.position"></p>
                    </div>
                    <button @click="logout()" class="w-9 h-9 rounded-xl flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-500 transition-colors" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 h-full overflow-y-auto bg-[#F8FAFC] relative scroll-smooth">
            
            <header class="lg:hidden sticky top-0 z-10 glass px-5 h-16 flex items-center justify-between shadow-sm">
                <button @click="sidebarOpen = true" class="text-gray-500 active:scale-95 transition-transform"><i class="fa-solid fa-bars text-xl"></i></button>
                <span class="font-bold text-gray-700" x-text="pageTitle"></span>
                <div class="w-8"></div>
            </header>

            <div class="max-w-7xl mx-auto p-5 lg:p-10 pb-32">
                
                <div x-show="page==='home'" class="space-y-10" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4">
                    
                    <div class="flex flex-col md:flex-row justify-between items-end gap-6 pb-6 border-b border-gray-200">
                        <div>
                            <div class="flex items-center gap-2 text-gray-500 text-sm font-medium mb-2 bg-white px-3 py-1 rounded-full w-fit shadow-sm border border-gray-100">
                                <i class="fa-regular fa-calendar-check text-primary-500"></i> <span x-text="currentDate"></span>
                            </div>
                            <h2 class="text-4xl font-bold text-slate-800 tracking-tight">
                                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary-600 to-primary-400" x-text="user ? user.name.split(' ')[0] : '‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô'"></span> üëã
                            </h2>
                            <p class="text-gray-500 mt-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</p>
                        </div>
                        <div x-html="weatherWidget"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div @click="nav('sow')" class="group bg-white rounded-3xl shadow-card border border-gray-100 p-1 cursor-pointer card-hover relative overflow-hidden flex flex-col justify-between h-64">
                            <div class="absolute top-0 left-0 w-full h-1.5 bg-farm-sow"></div>
                            <div class="p-7 relative z-10">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-14 h-14 rounded-2xl bg-pink-50 text-farm-sow flex items-center justify-center text-3xl group-hover:scale-110 group-hover:bg-farm-sow group-hover:text-white transition-all duration-300 shadow-sm"><i class="fa-solid fa-venus"></i></div>
                                    <div class="bg-gray-50 p-2 rounded-full text-gray-300 group-hover:text-farm-sow transition-colors"><i class="fa-solid fa-arrow-up-right-from-square"></i></div>
                                </div>
                                <h3 class="text-gray-500 font-bold text-sm uppercase tracking-wide">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</h3>
                                <div class="flex items-baseline gap-2 mt-2">
                                    <span class="text-5xl font-bold text-slate-800" x-text="stats.sow">0</span>
                                    <span class="text-xs text-gray-400 font-medium">‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-7 py-4 border-t border-gray-100 flex items-center justify-between group-hover:bg-pink-50 transition-colors">
                                <span class="text-xs font-bold text-gray-500 group-hover:text-farm-sow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                                <i class="fa-solid fa-chevron-right text-xs text-gray-400 group-hover:text-farm-sow group-hover:translate-x-1 transition-all"></i>
                            </div>
                        </div>

                        <div @click="nav('fatten')" class="group bg-white rounded-3xl shadow-card border border-gray-100 p-1 cursor-pointer card-hover relative overflow-hidden flex flex-col justify-between h-64">
                            <div class="absolute top-0 left-0 w-full h-1.5 bg-farm-fatten"></div>
                            <div class="p-7 relative z-10">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-14 h-14 rounded-2xl bg-orange-50 text-farm-fatten flex items-center justify-center text-3xl group-hover:scale-110 group-hover:bg-farm-fatten group-hover:text-white transition-all duration-300 shadow-sm"><i class="fa-solid fa-piggy-bank"></i></div>
                                    <div class="bg-gray-50 p-2 rounded-full text-gray-300 group-hover:text-farm-fatten transition-colors"><i class="fa-solid fa-arrow-up-right-from-square"></i></div>
                                </div>
                                <h3 class="text-gray-500 font-bold text-sm uppercase tracking-wide">‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏π‡∏Ç‡∏∏‡∏ô</h3>
                                <div class="flex items-baseline gap-2 mt-2">
                                    <span class="text-5xl font-bold text-slate-800" x-text="stats.fatten">0</span>
                                    <span class="text-xs text-gray-400 font-medium">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-7 py-4 border-t border-gray-100 flex items-center justify-between group-hover:bg-orange-50 transition-colors">
                                <span class="text-xs font-bold text-gray-500 group-hover:text-farm-fatten">‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                                <i class="fa-solid fa-chevron-right text-xs text-gray-400 group-hover:text-farm-fatten group-hover:translate-x-1 transition-all"></i>
                            </div>
                        </div>

                        <div @click="nav('feed')" class="group bg-white rounded-3xl shadow-card border border-gray-100 p-1 cursor-pointer card-hover relative overflow-hidden flex flex-col justify-between h-64">
                            <div class="absolute top-0 left-0 w-full h-1.5 bg-farm-feed"></div>
                            <div class="p-7 relative z-10">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-14 h-14 rounded-2xl bg-yellow-50 text-farm-feed flex items-center justify-center text-3xl group-hover:scale-110 group-hover:bg-farm-feed group-hover:text-white transition-all duration-300 shadow-sm"><i class="fa-solid fa-wheat-awn"></i></div>
                                    <div class="bg-gray-50 p-2 rounded-full text-gray-300 group-hover:text-farm-feed transition-colors"><i class="fa-solid fa-arrow-up-right-from-square"></i></div>
                                </div>
                                <h3 class="text-gray-500 font-bold text-sm uppercase tracking-wide">‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏¢‡∏≤</h3>
                                <div class="flex items-baseline gap-2 mt-2">
                                    <span class="text-3xl font-bold" :class="stats.feed.includes('‡∏õ‡∏Å‡∏ï‡∏¥')?'text-primary-600':'text-red-500'" x-text="stats.feed">...</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-7 py-4 border-t border-gray-100 flex items-center justify-between group-hover:bg-yellow-50 transition-colors">
                                <span class="text-xs font-bold text-gray-500 group-hover:text-farm-feed">‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
                                <i class="fa-solid fa-chevron-right text-xs text-gray-400 group-hover:text-farm-feed group-hover:translate-x-1 transition-all"></i>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-slate-700 font-bold mb-5 flex items-center gap-2 text-lg"><i class="fa-solid fa-bolt text-yellow-400"></i> ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î (Quick Actions)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-5">
                             <button @click="nav('sales')" class="bg-white p-5 rounded-2xl border border-gray-100 hover:border-green-400 hover:shadow-lg transition-all flex items-center gap-4 group pin-btn text-left">
                                <div class="w-12 h-12 rounded-full bg-green-50 text-green-600 flex items-center justify-center group-hover:bg-green-500 group-hover:text-white transition-colors text-xl"><i class="fa-solid fa-receipt"></i></div>
                                <div>
                                    <div class="text-sm font-bold text-gray-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
                                    <div class="text-[10px] text-gray-400">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
                                </div>
                             </button>

                             <button @click="nav('qrcode')" class="bg-white p-5 rounded-2xl border border-gray-100 hover:border-gray-400 hover:shadow-lg transition-all flex items-center gap-4 group pin-btn text-left">
                                <div class="w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center group-hover:bg-gray-700 group-hover:text-white transition-colors text-xl"><i class="fa-solid fa-qrcode"></i></div>
                                <div>
                                    <div class="text-sm font-bold text-gray-700">QR Code</div>
                                    <div class="text-[10px] text-gray-400">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏Å</div>
                                </div>
                             </button>

                             <button @click="checkUserThenNav('hr_time')" class="bg-white p-5 rounded-2xl border border-gray-100 hover:border-blue-400 hover:shadow-lg transition-all flex items-center gap-4 group pin-btn text-left">
                                <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center group-hover:bg-blue-500 group-hover:text-white transition-colors text-xl"><i class="fa-solid fa-clock"></i></div>
                                <div>
                                    <div class="text-sm font-bold text-gray-700">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                                    <div class="text-[10px] text-gray-400">‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô GPS</div>
                                </div>
                             </button>

                             <button @click="checkUserThenNav('hr_doc')" class="bg-white p-5 rounded-2xl border border-gray-100 hover:border-teal-400 hover:shadow-lg transition-all flex items-center gap-4 group pin-btn text-left">
                                <div class="w-12 h-12 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center group-hover:bg-teal-500 group-hover:text-white transition-colors text-xl"><i class="fa-solid fa-file-contract"></i></div>
                                <div>
                                    <div class="text-sm font-bold text-gray-700">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
                                    <div class="text-[10px] text-gray-400">‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</div>
                                </div>
                             </button>
                        </div>
                    </div>
                </div>

                <div x-show="page.startsWith('hr_')" x-cloak>
                    <div class="mb-8 flex items-center justify-between">
                         <div>
                             <h2 class="text-2xl font-bold text-gray-800" x-text="pageTitle"></h2>
                             <p class="text-sm text-gray-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
                         </div>
                         <button @click="nav('home')" class="text-sm text-gray-500 hover:text-gray-800 bg-white px-4 py-2 rounded-xl border border-gray-200 shadow-sm"><i class="fa-solid fa-arrow-left mr-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                    </div>

                    <div x-show="page==='hr_time'" class="flex flex-col items-center justify-center py-10 bg-white rounded-3xl border border-gray-100 shadow-sm relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-blue-600"></div>
                         <div class="relative w-64 h-64 flex items-center justify-center mb-6">
                            <div class="absolute inset-0 bg-blue-50 rounded-full animate-ping opacity-75"></div>
                            <div class="absolute inset-4 bg-blue-100 rounded-full opacity-50"></div>
                            <button @click="clockIn()" class="relative z-10 w-48 h-48 bg-white border-8 border-blue-50 rounded-full shadow-2xl flex flex-col items-center justify-center hover:scale-105 hover:border-blue-200 active:scale-95 transition-all group">
                                <i class="fa-solid fa-fingerprint text-7xl text-gray-300 group-hover:text-blue-500 transition-colors mb-3"></i>
                                <span class="font-bold text-lg text-gray-600 group-hover:text-blue-600 uppercase tracking-wider">‡∏Å‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
                                <span class="text-sm text-gray-400 mt-1 font-mono bg-gray-50 px-2 py-1 rounded" x-text="currentTime"></span>
                            </button>
                         </div>
                         <p class="text-gray-500 text-sm flex items-center gap-2"><i class="fa-solid fa-satellite-dish text-blue-500 animate-pulse"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    </div>

                    <div x-show="page==='hr_pay'" class="space-y-4">
                        <template x-for="p in data.payslips">
                            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 hover:border-green-300 transition-all group">
                                <div class="flex items-center gap-5 w-full md:w-auto">
                                    <div class="w-14 h-14 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 text-2xl group-hover:bg-green-500 group-hover:text-white transition-colors"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                                    <div>
                                        <div class="font-bold text-lg text-gray-800" x-text="p.period"></div>
                                        <div class="text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded inline-block mt-1" x-text="'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö: ' + p.date"></div>
                                    </div>
                                </div>
                                <div class="text-right w-full md:w-auto border-t md:border-t-0 border-gray-50 pt-4 md:pt-0">
                                    <div class="font-bold text-green-600 text-2xl" x-text="Number(p.netAmount).toLocaleString()+' ‡∏ø'"></div>
                                    <a :href="p.link" target="_blank" class="text-xs font-bold text-white bg-blue-500 hover:bg-blue-600 px-3 py-1.5 rounded-lg flex items-center justify-center gap-2 mt-2 transition-colors w-full md:w-auto"><i class="fa-solid fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</a>
                                </div>
                            </div>
                        </template>
                        <div x-show="data.payslips.length===0" class="text-center py-20 bg-white rounded-3xl border-2 border-dashed border-gray-200">
                            <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300"><i class="fa-solid fa-folder-open text-4xl"></i></div>
                            <p class="text-gray-400 font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                        </div>
                    </div>
                </div>

                <div x-show="page==='mgr_approve'" x-cloak>
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‚úçÔ∏è</h2>
                            <p class="text-sm text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
                        </div>
                        <button @click="nav('home')" class="bg-white px-4 py-2 rounded-xl border border-gray-200 text-sm font-bold text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-xmark mr-2"></i> ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
                    </div>

                    <div x-show="manager.pending.length === 0" class="text-center py-24 bg-white rounded-3xl border border-gray-100 shadow-sm">
                        <div class="w-24 h-24 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6 text-green-500 text-4xl shadow-inner">
                            <i class="fa-solid fa-check"></i>
                        </div>
                        <h3 class="font-bold text-gray-800 text-xl">‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!</h3>
                        <p class="text-gray-400 mt-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <template x-for="task in manager.pending">
                            <div class="bg-white p-6 rounded-3xl border border-gray-200 shadow-sm hover:shadow-lg transition-all relative overflow-hidden group">
                                <div class="absolute top-0 left-0 w-2 h-full" :class="task.type==='leave'?'bg-purple-500':'bg-orange-500'"></div>
                                <div class="pl-4">
                                    <div class="flex justify-between items-start mb-4">
                                        <span class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wide text-white shadow-sm" :class="task.type==='leave'?'bg-purple-500':'bg-orange-500'" x-text="task.title"></span>
                                        <span class="text-xs font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-md" x-text="task.date"></span>
                                    </div>
                                    <div class="flex items-center gap-3 mb-4">
                                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center font-bold text-sm text-gray-600 border border-gray-200" x-text="task.empId.substring(4)"></div>
                                        <div>
                                            <div class="font-bold text-gray-800 text-base" x-text="task.empId"></div>
                                            <div class="text-xs text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-2xl mb-5 border border-gray-100 text-sm text-gray-600 italic">
                                        "<span x-text="task.detail"></span>"
                                    </div>
                                    
                                    <div class="flex gap-3">
                                        <button @click="processTask(task, 'reject')" class="flex-1 py-3 rounded-xl border-2 border-red-50 text-red-500 font-bold text-sm hover:bg-red-50 hover:border-red-100 transition-colors">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        <button @click="processTask(task, 'approve')" class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold text-sm hover:bg-green-600 shadow-lg shadow-green-200 transition-colors">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div x-show="modals.pin" class="fixed inset-0 z-[60] bg-slate-50 flex flex-col items-center justify-center no-select" x-transition.opacity>
        <button @click="modals.pin=false" class="absolute top-8 right-8 w-12 h-12 bg-white rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 shadow-sm hover:shadow-md transition-all"><i class="fa-solid fa-xmark text-xl"></i></button>
        
        <div class="w-full max-w-md px-8 text-center" :class="{'shake': pinError}">
            
            <div class="mb-10">
                <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-6 text-primary-600 text-4xl shadow-lg shadow-primary-100 border border-primary-50">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <h3 class="text-3xl font-bold text-slate-800">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN</h3>
                <p class="text-gray-400 mt-2">‡∏£‡∏´‡∏±‡∏™ 4 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</p>
            </div>

            <div class="flex justify-center gap-6 mb-12">
                <template x-for="i in 4">
                    <div class="w-5 h-5 rounded-full border-2 transition-all duration-200" 
                         :class="pinInput.length >= i ? 'bg-primary-600 border-primary-600 scale-110' : 'bg-transparent border-gray-300'"></div>
                </template>
            </div>

            <div class="grid grid-cols-3 gap-6 max-w-xs mx-auto">
                <template x-for="n in [1,2,3,4,5,6,7,8,9]">
                    <button @click="addPin(n)" class="w-20 h-20 rounded-full bg-white text-3xl font-bold text-slate-700 shadow-sm border border-gray-100 pin-btn hover:shadow-md transition-all flex items-center justify-center mx-auto" x-text="n"></button>
                </template>
                
                <div class="flex items-center justify-center">
                    <button @click="modals.pin=false; modals.password=true" class="text-xs text-primary-600 font-bold hover:underline" title="‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ó‡∏ô">
                        ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                    </button>
                </div>
                <button @click="addPin(0)" class="w-20 h-20 rounded-full bg-white text-3xl font-bold text-slate-700 shadow-sm border border-gray-100 pin-btn hover:shadow-md transition-all flex items-center justify-center mx-auto">0</button>
                <button @click="delPin()" class="w-20 h-20 rounded-full flex items-center justify-center text-gray-400 pin-btn hover:text-red-500 hover:bg-red-50 transition-colors mx-auto">
                    <i class="fa-solid fa-delete-left text-2xl"></i>
                </button>
            </div>

            <div class="mt-12 border-t border-gray-200 pt-6">
                <p class="text-gray-400 text-sm mb-3">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà?</p>
                <button @click="modals.pin=false; modals.register=true" class="bg-white border border-primary-200 text-primary-700 px-6 py-3 rounded-xl text-sm font-bold shadow-sm hover:bg-primary-50 transition-all w-full">
                    <i class="fa-solid fa-user-plus mr-2"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>

    <div x-show="modals.password" class="fixed inset-0 z-[65] bg-black/60 backdrop-blur-md flex items-center justify-center p-4" x-transition.opacity>
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden" @click.outside="modals.password=false">
            <div class="p-8">
                <h3 class="text-xl font-bold text-center text-gray-800 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
                <div class="space-y-4">
                    <input type="text" x-model="loginForm.id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (EMP-XXX)" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-center font-bold outline-none focus:ring-2 focus:ring-primary-500">
                    <input type="password" x-model="loginForm.pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-center font-bold outline-none focus:ring-2 focus:ring-primary-500">
                    <button @click="doLogin()" class="w-full py-4 bg-primary-600 text-white font-bold rounded-xl shadow-lg hover:bg-primary-700 active:scale-95 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
                <div class="mt-4 text-center">
                    <button @click="modals.password=false; modals.pin=true" class="text-sm text-gray-400 hover:text-primary-600">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ PIN</button>
                </div>
            </div>
        </div>
    </div>

   <div x-show="modals.register" class="fixed inset-0 z-[70] bg-slate-100 flex flex-col items-center justify-center p-4" x-transition.opacity>
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
            <div class="p-5 bg-primary-600 text-white flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg"><i class="fa-solid fa-id-card mr-2"></i> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                    <p class="text-primary-100 text-xs mt-0.5">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
                <button @click="modals.register=false" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-5 custom-scroll">
                
                <div class="border-b border-gray-100 pb-2 mb-2">
                    <h4 class="text-primary-600 font-bold text-sm flex items-center gap-2">
                        <i class="fa-solid fa-user-tag"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                    </h4>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 ml-1 block mb-1">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô <span class="text-red-500">*</span></label>
                        <input x-model="regForm.id" placeholder="EMP-XXX" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-primary-500 outline-none text-center">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 ml-1 block mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></label>
                        <input x-model="regForm.name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏£‡∏¥‡∏á" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 ml-1 block mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input x-model="regForm.phone" type="tel" placeholder="08x-xxx-xxxx" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 ml-1 block mb-1">LINE ID</label>
                        <input x-model="regForm.line" placeholder="‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>

                <div>
                    <label class="text-[11px] font-bold text-gray-500 ml-1 block mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                    <textarea x-model="regForm.address" rows="2" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏´‡∏°‡∏π‡πà, ‡∏ï‡∏≥‡∏ö‡∏•, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary-500 resize-none"></textarea>
                </div>

                <div class="border-b border-gray-100 pb-2 mb-2 mt-4">
                    <h4 class="text-primary-600 font-bold text-sm flex items-center gap-2">
                        <i class="fa-solid fa-briefcase"></i> ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
                    </h4>
                </div>
                <div>
                    <label class="text-[11px] font-bold text-gray-500 ml-1 block mb-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô</label>
                    <select x-model="regForm.position" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>
                        <option>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
                        <option>‡∏™‡∏±‡∏ï‡∏ß‡∏ö‡∏≤‡∏•</option>
                        <option>‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏´‡∏°‡∏π</option>
                        <option>‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>
                        <option>‡∏£‡∏õ‡∏†.</option>
                        <option>‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 ml-1 block mb-1">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                        <input x-model="regForm.bank" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£, ‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 ml-1 block mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <input x-model="regForm.acc_no" placeholder="xxx-x-xxxxx-x" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>

                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mt-2">
                    <h4 class="text-yellow-800 font-bold text-sm mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-user-shield"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <label class="text-[10px] text-yellow-700 font-bold block mb-1">PIN 4 ‡∏´‡∏•‡∏±‡∏Å (‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πà‡∏ß‡∏ô) <span class="text-red-500">*</span></label>
                            <input type="tel" x-model="regForm.pin" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full text-center text-3xl font-bold tracking-[0.5em] text-slate-700 bg-white border border-yellow-300 rounded-lg py-2 focus:ring-2 focus:ring-yellow-400 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-yellow-700 font-bold block mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏™‡∏≥‡∏£‡∏≠‡∏á)</label>
                            <input type="text" x-model="regForm.pass" placeholder="Password" class="w-full p-3 bg-white border border-yellow-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-yellow-400">
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-5 bg-gray-50 border-t border-gray-200">
                <button @click="submitRegister()" class="w-full py-3.5 bg-primary-600 text-white font-bold rounded-xl shadow-lg hover:bg-primary-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>
            <div class="p-6 bg-gray-50 border-t border-gray-100">
                <button @click="submitRegister()" class="w-full py-4 bg-primary-600 text-white font-bold rounded-xl shadow-lg hover:bg-primary-700 active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                // State
                sidebarOpen: false, loading: false, loadingText: '',
                page: 'home', pageTitle: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°',
                user: null, appUrl: '', currentTime: '', currentDate: '',
                pinError: false,
                
                // Config
                menus: {
                    main: [{id:'home', label:'‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°', icon:'fa-solid fa-chart-pie'},{id:'sow', label:'‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', icon:'fa-solid fa-venus'},{id:'fatten', label:'‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏π‡∏Ç‡∏∏‡∏ô', icon:'fa-solid fa-piggy-bank'},{id:'feed', label:'‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏¢‡∏≤', icon:'fa-solid fa-wheat-awn'}],
                    hr: [{id:'hr_time', label:'‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', icon:'fa-solid fa-clock'},{id:'hr_pay', label:'‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon:'fa-solid fa-file-invoice-dollar'},{id:'hr_doc', label:'‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô', icon:'fa-solid fa-folder'}],
                    manager: [{id:'mgr_approve', label:'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠', icon:'fa-solid fa-file-signature'}]
                },
                
                // Data Containers
                stats: { sow:0, fatten:0, feed:'...' },
                data: { sales:[], qr:[], payslips:[] },
                manager: { pending: [] },
                weatherWidget: '',
                
                // Forms & Inputs
                modals: { pin: false, register: false, password: false },
                pinInput: '',
                loginForm: { id:'', pass:'' },
                regForm: { id:'', name:'', phone:'', line:'', address:'', position:'', bank:'', acc_no:'', pin:'', pass:'' },

                // --- 1. INITIALIZATION ---
                initApp() {
                    // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ URL ‡∏à‡∏≤‡∏Å Controller.gs
                    this.appUrl = "<?= appUrl ?>";
                    
                    // Start Clock
                    setInterval(() => { 
                        const now = new Date(); 
                        this.currentTime = now.toLocaleTimeString('th-TH'); 
                        this.currentDate = now.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long', year:'numeric'}); 
                    }, 1000);

                    // Load Dashboard Data
                    this.safeRun('main_getGlobalStats', d => this.stats = d);
                    this.safeRun('main_getWeatherUpdate', d => { 
                        if(d.success) this.weatherWidget = `<div class="bg-white px-3 py-1.5 rounded-full shadow-sm border border-gray-100 flex items-center gap-2 text-sm text-gray-600"><span class="text-2xl">${d.icon}</span> <span class="font-bold">${d.temp}¬∞C</span></div>`; 
                    });
                },

                // --- 2. ROUTING ---
                nav(p) {
                    const internalPages = ['home', 'sales', 'qrcode', 'hr_time', 'hr_pay', 'hr_doc', 'mgr_approve'];
                    
                    if(internalPages.includes(p)) {
                        // Internal SPA Navigation
                        this.page = p; 
                        this.sidebarOpen = false; 
                        this.updateTitle(p);
                        
                        // Lazy Load Specific Data
                        if(p === 'sales') this.safeRun('farm_getSalesHistory', d => this.data.sales = d);
                        if(p === 'qrcode') this.safeRun('farm_getQrCodes', d => this.data.qr = d);
                        if(p === 'mgr_approve') this.safeRun('hr_getPendingRequests', d => this.manager.pending = d);
                        if(p.startsWith('hr_') && this.user) this.safeRun('user_getData', d => this.data.payslips = d.payslips, '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', this.user.id);
                    
                    } else {
                        // External Page Navigation (Separate Files)
                        if(this.appUrl) {
                            // Show loading before redirect
                            this.loading = true; this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ' + p + '...';
                            window.top.location.href = this.appUrl + "?page=" + p;
                        } else {
                            console.log("Redirect to: " + p);
                        }
                    }
                },
                
                updateTitle(p) { const f = [...this.menus.main, ...this.menus.hr, ...this.menus.manager].find(m => m.id === p); this.pageTitle = f ? f.label : 'Niphon Farm'; },
                checkUserThenNav(p) { if(!this.user) this.modals.pin = true; else this.nav(p); },

                // --- 3. PIN SYSTEM ---
                openPinModal() { this.pinInput = ''; this.modals.pin = true; this.pinError = false; },
                
                addPin(n) {
                    if(this.pinInput.length < 4) {
                        this.pinInput += n;
                        if(this.pinInput.length === 4) {
                            setTimeout(() => this.doPinLogin(), 200); // Small delay for UX
                        }
                    }
                },
                
                delPin() { this.pinInput = this.pinInput.slice(0, -1); this.pinError = false; },
                
                doPinLogin() {
                    this.safeRun('auth_loginByPin', res => {
                        if(res.success) {
                            this.user = res.user;
                            this.modals.pin = false;
                            this.modals.password = false;
                            
                            // Success Toast
                            const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 3000, timerProgressBar: true });
                            Toast.fire({ icon: 'success', title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì' + this.user.name.split(' ')[0] });
                            
                            // Load Admin Tasks
                            if(this.user.role === 'admin' || this.user.role === 'manager') this.safeRun('hr_getPendingRequests', d => this.manager.pending = d);
                        } else {
                            // Error Feedback
                            this.pinInput = ''; 
                            this.pinError = true;
                            setTimeout(() => this.pinError = false, 500);
                            
                            const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 2000 });
                            Toast.fire({ icon: 'error', title: '‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' });
                        }
                    }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', this.pinInput);
                },

                // --- 4. FALLBACK & REGISTER ---
                doLogin() {
                    if(!this.loginForm.id || !this.loginForm.pass) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
                    this.safeRun('auth_checkLogin', res => {
                        if(res.success) {
                            this.user = res.user;
                            this.modals.password = false;
                            this.modals.pin = false;
                            Swal.fire({ icon:'success', title:'‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', text: this.user.name, timer:1500, showConfirmButton:false });
                            if(this.user.role === 'admin' || this.user.role === 'manager') this.safeRun('hr_getPendingRequests', d => this.manager.pending = d);
                        } else {
                            Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res.message, 'error');
                        }
                    }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', this.loginForm.id, this.loginForm.pass);
                },

                submitRegister() {
                    if(!this.regForm.id || !this.regForm.name || !this.regForm.pin) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ *', 'warning');
                    if(this.regForm.pin.length !== 4) return Swal.fire('PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'warning');
                    
                    this.safeRun('hr_registerUser', res => {
                        if(res.success) {
                            Swal.fire({ icon:'success', title:'‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ PIN ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ' });
                            this.modals.register = false;
                            this.modals.pin = true;
                            this.regForm = { id:'', name:'', position:'', pass:'', pin:'' };
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', this.regForm);
                },

                // --- 5. LOGOUT & UTILS ---
                logout() {
                    Swal.fire({ title:'‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', icon:'question', showCancelButton:true, confirmButtonColor:'#ef4444' }).then(r => {
                        if(r.isConfirmed) { this.user = null; this.nav('home'); }
                    });
                },

                processTask(task, action) {
                    Swal.fire({ title: action==='approve'?'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?':'‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠?', text: task.title + ' ‡πÇ‡∏î‡∏¢ ' + task.empId, icon: 'warning', showCancelButton: true, confirmButtonColor: action==='approve'?'#10b981':'#ef4444'}).then((result) => {
                        if (result.isConfirmed) {
                            this.safeRun('hr_processRequest', (res) => {
                                if(res) { Swal.fire('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '', 'success'); this.nav('mgr_approve'); } 
                                else { Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
                            }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', { id: task.id, type: task.type, action: action, approver: this.user.name });
                        }
                    });
                },

                clockIn() {
                    if(!navigator.geolocation) return Swal.fire('GPS Error','‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö','error');
                    Swal.fire({title:'‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î...', didOpen:()=>Swal.showLoading()});
                    navigator.geolocation.getCurrentPosition(pos => {
                        Swal.close();
                        this.safeRun('hr_submitTimeLog', res => { Swal.fire(res.success?'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à':'‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', res.message, res.success?'success':'error'); }, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤...', { empId: this.user.id, empName: this.user.name, lat: pos.coords.latitude, lng: pos.coords.longitude });
                    });
                },

                safeRun(func, callback, msg, ...args) {
                    if(msg) { this.loading = true; this.loadingText = msg; }
                    google.script.run.withSuccessHandler(res => { this.loading = false; callback(res); }).withFailureHandler(e => { this.loading = false; Swal.fire('System Error', e.message, 'error'); })[func](...args);
                }
            }
        }
    </script>
</body>
</html>
